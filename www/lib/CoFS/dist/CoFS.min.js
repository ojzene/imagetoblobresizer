/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(t,e){if("function"==typeof define&&define.amd)define(["async","buffer","eventemitter2"],e);else{var n=t.CoFS;t.CoFS=e(t.async,t.buffer,t.EventEmitter2),t.CoFS.noConflict=function(){return t.CoFS=n,CoFS}}}(this,function(t,e,n){var r,i,o;return function(t){function e(t,e){return _.call(t,e)}function n(t,e){var n,r,i,o,s,f,u,l,c,a,p,d=e&&e.split("/"),h=m.map,y=h&&h["*"]||{};if(t&&"."===t.charAt(0))if(e){for(d=d.slice(0,d.length-1),t=t.split("/"),s=t.length-1,m.nodeIdCompat&&b.test(t[s])&&(t[s]=t[s].replace(b,"")),t=d.concat(t),c=0;c<t.length;c+=1)if(p=t[c],"."===p)t.splice(c,1),c-=1;else if(".."===p){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((d||y)&&h){for(n=t.split("/"),c=n.length;c>0;c-=1){if(r=n.slice(0,c).join("/"),d)for(a=d.length;a>0;a-=1)if(i=h[d.slice(0,a).join("/")],i&&(i=i[r])){o=i,f=c;break}if(o)break;!u&&y&&y[r]&&(u=y[r],l=c)}!o&&u&&(o=u,f=l),o&&(n.splice(0,f,o),t=n.join("/"))}return t}function s(e,n){return function(){var r=F.call(arguments,0);return"string"!=typeof r[0]&&1===r.length&&r.push(null),d.apply(t,r.concat([e,n]))}}function f(t){return function(e){return n(e,t)}}function u(t){return function(e){g[t]=e}}function l(n){if(e(v,n)){var r=v[n];delete v[n],w[n]=!0,p.apply(t,r)}if(!e(g,n)&&!e(w,n))throw new Error("No "+n);return g[n]}function c(t){var e,n=t?t.indexOf("!"):-1;return n>-1&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function a(t){return function(){return m&&m.config&&m.config[t]||{}}}var p,d,h,y,g={},v={},m={},w={},_=Object.prototype.hasOwnProperty,F=[].slice,b=/\.js$/;h=function(t,e){var r,i=c(t),o=i[0];return t=i[1],o&&(o=n(o,e),r=l(o)),o?t=r&&r.normalize?r.normalize(t,f(e)):n(t,e):(t=n(t,e),i=c(t),o=i[0],t=i[1],o&&(r=l(o))),{f:o?o+"!"+t:t,n:t,pr:o,p:r}},y={require:function(t){return s(t)},exports:function(t){var e=g[t];return"undefined"!=typeof e?e:g[t]={}},module:function(t){return{id:t,uri:"",exports:g[t],config:a(t)}}},p=function(n,r,i,o){var f,c,a,p,d,m,_=[],F=typeof i;if(o=o||n,"undefined"===F||"function"===F){for(r=!r.length&&i.length?["require","exports","module"]:r,d=0;d<r.length;d+=1)if(p=h(r[d],o),c=p.f,"require"===c)_[d]=y.require(n);else if("exports"===c)_[d]=y.exports(n),m=!0;else if("module"===c)f=_[d]=y.module(n);else if(e(g,c)||e(v,c)||e(w,c))_[d]=l(c);else{if(!p.p)throw new Error(n+" missing "+c);p.p.load(p.n,s(o,!0),u(c),{}),_[d]=g[c]}a=i?i.apply(g[n],_):void 0,n&&(f&&f.exports!==t&&f.exports!==g[n]?g[n]=f.exports:a===t&&m||(g[n]=a))}else n&&(g[n]=i)},r=i=d=function(e,n,r,i,o){if("string"==typeof e)return y[e]?y[e](n):l(h(e,n).f);if(!e.splice){if(m=e,m.deps&&d(m.deps,m.callback),!n)return;n.splice?(e=n,n=r,r=null):e=t}return n=n||function(){},"function"==typeof r&&(r=i,i=o),i?p(t,e,n,r):setTimeout(function(){p(t,e,n,r)},4),d},d.config=function(t){return d(t)},r._defined=g,o=function(t,n,r){n.splice||(r=n,n=[]),e(g,t)||e(v,t)||(v[t]=[t,n,r])},o.amd={jQuery:!0}}(),o("node_modules/almond/almond",function(){}),o("cofs/array2buffer",["buffer"],function(t){"use stricts";var e=t.Buffer,n=function(t){var n,r,i,o,s;if(s=new Int8Array(t),o=new e(s),i=t.byteLength,o.length||!i)return s=null,o;for(o=new e(i),n=0;i>n;n++)r=s[n],o.writeUInt8(r,n);return s=null,o};return n}),o("cofs/promise",[],function(){"use stricts";var t=function(t){if("function"!=typeof t)throw new Error("Listener not defined");return function(){var e=Array.prototype.slice.call(arguments);t.apply({},e)}};return t}),o("cofs/readstream",["async","eventemitter2"],function(t,e){"use stricts";var n,r,i=function(){Error.call(this)};i.prototype=new Error;var o=function(){this.initialize.apply(this,arguments)};return o.prototype=new e,o.prototype.initialize=function(t,i,o){if(e.call(this),o=o||{},n=window.File||void 0,r=window.Blob||void 0,"undefined"==typeof n)throw new Error("File componet does not exits");if("undefined"==typeof r)throw new Error("Blob componet does not exists");if(this._fs=t,this._file=i,this._blockSize=o.blockSize||4096,this._start=o.start||0,this._end=void 0!==o.end?o.end:void 0,this._paused=!1,this._stoped=!1,this._end<=this._start)throw new Error("Start byte has been bigger that end byte")},o.prototype._error=function(t){var e=this.emit("error",t);if(!e)throw t},o.prototype.getFile=function(t){var e=this._fs,i=this._file;return i instanceof n||i instanceof r?t(void 0,i):void e.getFileEntry(i,function(e,n){return e?t(e):void n.file(function(e){return t(void 0,e)})})},o.prototype.start=function(){var e=this,n=this._start,r=this._end,o=this._blockSize;this.getFile(function(s,f){if(s)return e._error(s);"undefined"==typeof r&&(r=f.size);var u=n;t.whilst(function(){return r>=u},function(t){var n=function(n){return e.emit("data",n),t()};e._fs.readFilePart(f,u,u+o,function(r,s){return u+=o,r?void t(r):e._paused?e.once("resume",function(){n(s)}):e._stoped?t(new i):void n(s)})},function(t){return t instanceof i?void 0:t?e._error(t):e.emit("finish")})})},o.prototype.pause=function(){this._paused=!0,this.emit("pause")},o.prototype.resume=function(){this._paused=!1,this.emit("resume")},o.prototype.stop=function(){this._stoped=!0,this.emit("stop")},o}),o("cofs/fs",["async","buffer","./array2buffer","./promise","./readstream"],function(t,e,n,r,i){"use stricts";var o=e.Buffer,s=null,f=null,u=null,l=function(){this.initialize.apply(this,arguments)};return l.VERSION="0.4.2",l.prototype.initialize=function(t){if(s||(s=window.FileReader||null),f||(f=window.requestFileSystem||window.webkitRequestFileSystem||null),u||(u=window.File||null),!s||!u)throw new Error("Objects of file API does not exists!");this._eventsListeners={},this._fs=null,t=t||{},this._options=t},l.prototype._log=function(){this._options.logger&&this._options.logger.apply({},arguments)},l.prototype._error=function(t){if("object"!=typeof t&&(t=new Error(t)),this._log("CoFS Error"+t.message),!this.emit("error",t))throw t;return t},l.prototype.on=function(t,e,n){"undefined"==typeof this._eventsListeners[t]&&(this._eventsListeners[t]=[]),this._eventsListeners[t].push({cb:e,once:n||!1})},l.prototype.once=function(t,e){return this.on(t,e,!0)},l.prototype.emit=function(){if(!arguments.length)return!1;var t,e=Array.prototype.slice.call(arguments,0),n=e.shift(),r=this._eventsListeners[n]||[];for(this._log("emiting "+n),t=0;t<e.length;t++)r[t]&&(r[t].cb.apply(this,e),r[t].once&&(r[t]=null));return t},l.prototype.getFileSystem=function(t,e){var n=this;return f?("function"==typeof t&&(e=t,t={}),this._log("Open FileSystem",t),void f(window[t.fs||"PERSISTENT"],0,function(t){n._fs=t,e(null,t)},function(t){n._log("Error getting FileSystem",t),n._error(t)})):e(new Error("The browser has not requestFileSystem"))},l.prototype.getDirectory=function(t,e,n){var r=this;"function"==typeof e&&(n=e,e=void 0);var i=!1;e=e||{},this.getFileSystem(function(o,s){s.root.getDirectory(t,e,function(t){return i?void 0:(i=!0,n(void 0,t))},function(t){return i?void 0:(i=!0,r._log("Error getting directory entry",t),r._error(t),n(t))})})},l.prototype.getFileEntry=function(t,e,n){"function"==typeof e&&(n=e,e={});var r=e.root||void 0;if(this._log("Getting FileEntry for",t,e),"object"==typeof t)return n(null,t);var i=this;this.getFileSystem(function(o,s){return o?n(o):("undefined"==typeof r&&(r=s.root),void r.getFile(t,e,function(e){i.emit("fileentry:"+t,e),n(null,e)},function(t){i._log("Error getting FileEntry",t),n(t)}))})},l.prototype.readFromFileObject=function(t,e){var r=this;this._log("Creating filereader object",t);var i=new s;i.onloadend=function(){if(r._log("load end call! with large (relative): ",this.result.length),!this.result)return null;var t=n(this.result);e(null,t)},i.onerror=function(t){r._log("Error Reading file",t),e(new Error("Reading file"))},i.onabort=function(){r._log("Reading file Abort!!"),e(new Error("Reading abort"))},i.readAsArrayBuffer(t)},l.prototype.readFromFileEntry=function(t,e){var n=this;t.file(function(t){n.readFromFileObject(t,e)})},l.prototype.readFile=function(t,e){var n=this;return t instanceof u||t instanceof Blob?this.readFromFileObject(t,e):void this.getFileEntry(t,function(t,r){return t?e(t):void n.readFromFileEntry(r,e)})},l.prototype.writeFile=function(t,e,n,r){var i=this;o.isBuffer(e)?(r=n,n=void 0):e=new o(e,n),this.getFileSystem(function(n){if(n)return r(n);var o={create:!0,exclusive:!0};i.getFileEntry(t,o,function(n,i){return n?r(new Error("Error getting file access "+n.message)):void i.createWriter(function(t){t.onwriteend=function(){r(null)},t.onerror=function(t){r(new Error(t.toString()))};var n=new Blob([e],{type:"application/octet-stream"});t.write(n)},function(){r(new Error("Error writing "+t))})})})},l.prototype.readFilePart=function(t,e,n,r){if("function"!=typeof t.slice)if("function"===t.mozSlice)t.slice=t.mozSlice;else{if("function"!==t.webkitSlice){var i=this._error("File has not slice method");return r(i)}t.slice=t.webkitSlice}return this.readFromFileObject(t.slice(e,n),r)},l.prototype.createReadStream=function(t,e){var n=new i(this,t,e);return n},l}),o("async",function(){return t}),o("buffer",function(){return e}),o("eventemitter2",function(){return n}),i("cofs/fs")});